<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Authpf: Потребителски shell за аутентикиращи  gateways</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
<meta name="copyright"     content="This document copyright 2003 by OpenBSD.">
</head>

<body bgcolor="#ffffff" text="#000000">

<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif">
<p>
[<a href="ftp.html">Преди: Проблеми с FTP</a>]
[<a href="index.html">Съдържание</a>]
[<a href="example1.html">Следва: Пример #1: Firewall за дома или за малък 
офис</a>]

<h1><font color="#e00000">PF: Authpf: Потребителски shell за аутентикиращи
gateways</font></h1>

<hr>

<h3>Съдържание</h3>
<ul>
<li><a href="#intro">Въведение</a>
<li><a href="#config">Конфигуриране</a>
	<ul>
	<li><a href="#linkmain">Свързване на Authpf към основния набор с
            правила (Main Ruleset)</a>
	<li><a href="#loadrules">Конфигуриране на заредените правила</a>
	<li><a href="#acl">Списъци за контрол на достъпа (Access Control
            Lists)</a>
	<li><a href="#shell">Присвояване на Authpf за потребителски shell</a>
	</ul>
<li><a href="#wholog">Кой с свързан в момента?</a>
<li><a href="#moreinfo">Повече информация</a>
<li><a href="#example">Пример</a>
</ul>

<hr>

<a name="intro"></a>
<h2>Въведение</h2>
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=authpf&amp;sektion=8&amp;manpath=OpenBSD+3.3"
>Authpf(8)</a> е потребителски shell за аутентикиращи gateways.
Аутентикиращият gateway се различава от обикновения мрежов gateway (познат
още като router), по това, че потребителите първо трябва да се аутентикират
(да докажат автентичността си -- б.пр.), преди gateway-а да разреши трафика им
да преминава през него. Когато потребителският shell е зададен като
<tt>/usr/sbin/authpf</tt> (вместо да бъде зададен като например
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ksh&amp;sektion=1&amp;manpath=OpenBSD+3.3"
>ksh(1)</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=csh&amp;sektion=1&amp;manpath=OpenBSD+3.3"
>csh(1)</a> и т.н.) и потребителят се свърже с използване например на SSH, 
authpf ще направи необходимите промени в активния
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4&amp;manpath=OpenBSD+3.3"
>pf(4)</a> набор от правила, така че преминаващият трафик на потребителя да
бъде филтриран и/или преобразуван (Network Address Translation) или пренасочен.
Когато сесията на потребителя се прекъсне, authpf ще премахне правилата,
заредени за този потребител и ще прекъсне съхранените stateful връзки, които
той е отворил. По тази причина трафикът на потребителят има възможност да
преминава през gateway-а само докато SSH сесията на потребителя е отворена.

<p>
Authpf променя набора от правила на 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4&amp;manpath=OpenBSD+3.3"
>pf(4)</a> чрез добавяне на правила в
<a href="anchors.html#named">именувани набори с правила</a>, свързани с
<a href="anchors.html">точка за закачане</a>. Всеки път когато потребителят
се аутентикира, authpf създава нов именуван набор правила и зарежда в него
предварително конфигурирани
<a href="filter.html">филтриращи</a>, <a href="nat.html"><tt>nat</tt></a>,
<a href="nat.html#binat"><tt>binat</tt></a> и
<a href="rdr.html"><tt>rdr</tt></a> правила. Правилата, които authpf
зарежда могат да се задават глобално или специално за определен потребител.

<p>
Authpf може да се използва например да:
<ul>
<li>изисква потребителите да се аутентикират, преди да им се разреши достъп
до Интернет.
<li>предоставя на определени потребители (напр. мрежови администратори) достъп
до забранени за останалите потребители участъци от мрежата.
<li>разрешава само на извесни потребители да имат достъп до Интернет от
wireless мрежовия сегмент.
<li>разрешава на работниците достъп от домовете им до ресурсите на фирмата.
За потребители, намиращи се извън офиса на фирмата може не само да се даде
достъп до ресурсите на фирмата, но и те да бъдат пренасочени към специфични
ресурси (напр. собственият им фирмен компютър) на базата на името, с което
те се аутентикират.
<li>ограничен Интернет достъп за гостите на библиотека или обществени
терминали. На регистрираните потребители authpf може да предостави неограничен
достъп.
</ul>

<p>
Authpf регистрира името на потребителя (username), неговия IP адрес, както и 
времето на започване и завършване на сесията. Регистрацията е чрез
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=syslogd&amp;sektion=8&amp;manpath=OpenBSD+3.3"
>syslogd(8)</a>. От тази имформация системният администратор може да разбере
кой е бил свързан и кога, както и да се направи отчет за използвания мрежов
трафик.

<a name="config"></a>
<h2>Конфигуриране</h2>
Тук са описани основните стъпки за конфигуриране на authpf. За пълно
описание на конфигурирането на authpf моля обръщайте се към 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=authpf&amp;sektion=8&amp;manpath=OpenBSD+3.3"
>authpf man страницата</a>.

<a name="linkmain"></a>
<h3>Свързване на Authpf към основния набор с правила</h3>
Authpf се свързва към основния набор от правила с използване на 
<tt>anchor</tt> правила:
<blockquote>
<tt>
nat-anchor authpf<br>
rdr-anchor authpf<br>
binat-anchor authpf<br>
anchor authpf<br>
</tt>
</blockquote>

<p>
Където и в набора да са разположени <tt>anchor</tt> правилата, PF ще се
отдели от основния набор с правила и ще обходи authpf правилата. Не е
необходимо винаги да се задават и 4-те вида <tt>anchor</tt> правила.
Ако например authpf не е конфигуриран да зарежда никакви <tt>nat</tt> правила,
<tt>nat-anchor</tt> правилото може да се пропусне.

<a name="loadrules"></a>
<h3>Конфигуриране на заредените правила</h3>
Authpf зарежда своите правила от един от следните два файла:
<ul>
<li><tt>/etc/authpf/users/$USER/authpf.rules</tt>
<li><tt>/etc/authpf/authpf.rules</tt>
</ul>

<p>
Първият файл съдържа правила, които се зареждат само когато потребителят 
<tt>$USER</tt> (заменя се с username на потребителя) се свърже. Съдържа
правилата специално за определен потребител (например за системния
администратор), различни от тези по подразбиране за останалите
потребители. Вторият фаил съдържа правилата по подразбиране, които се зареждат
за всички потребители, които нямат собствен <tt>authpf.rules</tt> файл.
Ако съществува файл специално за даден потребител, той има приоритет пред
файла по подразбиране. Трябва да съществува поне един от двата файла за да
работи authpf.

<p>
Синтаксисът на правилата за филтриране и преобразуване е еднакъв с този в
останалите PF набори от правила, с едно малко изключение: authpf позволява
използването на два предварително дефинирани макроса:
<ul>
<li><tt>$user_ip</tt> - IP адрес на свързания потребител
<li><tt>$user_id</tt> - името (username) на свързания потребител
</ul>

<p>
Препоръчва се използването на макроса <tt>$user_ip</tt> за разрешаване на
трафика през gateway-а само за вече аутентикирани потребители.

<a name="acl"></a>
<h3>Списъци за контрол на достъпа (Access Control Lists)</h3>
На потребител може да се забрани да използва authpf, чрез създаване в
директорията <tt>/etc/authpf/banned/</tt> на файл с име username на
потребителя. Съдържанието на файла ще бъде показано на този потребител при
опит за свързване и authpf ще прекъсне сесията му. Това предоставя удобен
начин потребителя да бъде уведомен защо му е забранен достъпа и към кого
да се обръща за да бъде той възстановен.

<p>
Респективно, възможно е да се разреши само на определени потребители достъп
до authpf, чрез въвеждане на техните usernames във файла
<tt>/etc/authpf/authpf.allow</tt>. Ако файлът <tt>/etc/authpf/authpf.allow</tt>
не съществува или съдържа само "<tt>*</tt>", authpf ще е разрешен за всеки
потребител, успешно свързан чрез SSH, ако достъпът му не е изрично забранен.

<p>
Ако authpf не може точно да определи дали достъпът за даден username е 
забранен или разрешен, ще се изведе кратко съобщение и потребителската
сесия ще бъде прекъсната. Запис от <tt>/etc/authpf/banned/</tt> винаги е с
предимство пред запис от <tt>/etc/authpf/authpf.allow</tt>.

<a name="shell"></a>
<h3>Присвояване на Authpf за потребителски shell</h3>
За да работи authpf, той трябва да бъде присвоен за shell на даден потребител.
Когато потребителят се аутентикира успешно пред
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sshd&amp;sektion=8&amp;manpath=OpenBSD+3.3"
>sshd(8)</a>, за shell ще му бъде присвоен authpf. После ще се провери дали
на потребителят е разрешено да използва authpf, ще се заредят правилата от
подходящия файл и т.н.

<p>
Има няколко начина authpf да бъде присвоен за shell на потребител:
<ol>
<li>"Ръчно", за всеки потребител с използване на
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=chsh&amp;sektion=1&amp;manpath=OpenBSD+3.3"
>chsh(1)</a>, 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vipw&amp;sektion=8&amp;manpath=OpenBSD+3.3"
>vipw(8)</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=useradd&amp;sektion=8&amp;manpath=OpenBSD+3.3"
>useradd(8)</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=usermod&amp;sektion=8&amp;manpath=OpenBSD+3.3"
>usermod(8)</a> и т.н.
<li>Чрез присвояване на потребителите на login class и промяна на
<tt>shell</tt> параметъра за този class в
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=login.conf&amp;sektion=5&amp;manpath=OpenBSD+3.3"
><tt>/etc/login.conf</tt></a>.
</ol>

<a name="wholog"></a>
<h2>Кой с свързан в момента?</h2>
След като потребителят веднъж се е свързал и authpf е заредил подходящите
PF правила, authpf променя името на процеса си, за да покаже username и IP
адреса на свързалия се потребител:
<pre>
    # ps -ax | grep authpf
    23664 p0  Is+     0:00.11 -authpf: charlie@192.168.1.3 (authpf)
</pre>

<p>
Тук потребителят <tt>charlie</tt> се е свързал от система с IP адрес
192.168.1.3. Чрез изпращане на сигнал SIGTERM към authpf процеса, 
потребителската сесия може принудително да се прекъсне. Auth ще премахне
също правилата за дадения потребител и ще прекъсне всички stateful връзки,
които той и отворил.
<pre>
    # kill -TERM 23664
</pre>

<a name="moreinfo"></a>
<h2>Повече информация</h2>
За пълно описание на конфигурирането на authpf моля обръщайте се към 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=authpf&amp;sektion=8&amp;manpath=OpenBSD+3.3"
>authpf man страницата</a>.

<a name="example"></a>
<h2>Пример</h2>
Authpf се използва в OpenBSD gateway за аутентикиране на потребителите на
wireless мрежа, която е част от по-голяма университетска мрежа. След като
веднъж потребителите се аутентикират, и ако не им е изрично забранено, им
се разрешава да се свързват с SSH навън и да разглеждат web (включително и
secure web) страници. Те могат също да използват университетските DNS
сървъри.

<p>
Файлът <tt>/etc/authpf/authpf.rules</tt> съдържа следните правила:<br>
<br>

<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
wifi_if = "wi0"
dns_servers = "{ 10.0.1.56, 10.0.2.56 }"

pass in quick on $wifi_if proto udp from $user_ip to $dns_servers \
   port domain keep state
pass in quick on $wifi_if proto tcp from $user_ip to port { ssh, http, \
   https } flags S/SA keep state
</pre>
</td></tr>
</table>

<p>
В добавка към използването на SSH и разглеждането на web страници,
администраторът <tt>charlie</tt> трябва да има достъп и до
университетските SMTP и POP3 сървъри. 
В <tt>/etc/authpf/users/charlie/authpf.rules</tt> има следните правила:<br>
<br>

<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
wifi_if = "wi0"
smtp_server = "10.0.1.50"
pop3_server = "10.0.1.51"
dns_servers = "{ 10.0.1.56, 10.0.2.56 }"

pass in quick on $wifi_if proto udp from $user_ip to $dns_servers \
   port domain keep state
pass in quick on $wifi_if proto tcp from $user_ip to $smtp_server \
   port smtp flags S/SA keep state
pass in quick on $wifi_if proto tcp from $user_ip to $pop3_server \
   port pop3 flags S/SA keep state
pass in quick on $wifi_if proto tcp from $user_ip to port { ssh, http, \
   https } flags S/SA keep state
</pre>
</td></tr>
</table>

<p>
Основният набор с правила (main ruleset), намиращ се в <tt>/etc/pf.conf</tt> 
съдържа следното:<br>
<br>

<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
# макроси
wifi_if = "wi0"
ext_if  = "fxp0"

scrub in all

# филтриране
block drop all

pass out quick on $ext_if proto tcp from $wifi_if:network flags S/SA \
   modulate state
pass out quick on $ext_if proto { udp, icmp } from $wifi_if:network \
   keep state

pass in quick on $wifi_if proto tcp from $wifi_if:network to $wifi_if \
   port ssh flags S/SA keep state

anchor authpf in on $wifi_if
</pre>
</td></tr>
</table>

<p>
Наборът с правила по-горе е твърде опростен и извършва следното: 
<ul>
<li>Блокира всичко (забрана по подразбиране).
<li>На външният интерфейс пропуска изходящия TCP, UDP и ICMP трафик от
wireless мрежата.
<li>Пропуска входящият SSH трафик от wireless мрежата, предназначен за самия
gateway. Това правило е необходимо за да се разреши на потребителите да се
свързват.
<li>Създава точка на закачане с име "authpf" за входящия трафик на wireless
интерфейса.
</ul>

<p>
Идеята, на която е базиран основния набор с правила е следната: блокиране
на всичко и разрешаване на колкото е възможно по-малък трафик. Трафикът
свободно излиза от външния интерфейс, но навлизането му е блокирано от
забраната по подразбиране на wireless интерфейса. Когато потребителите
се аутентикират, на трафикът им се разрешава да преминава през wireless
интерфейса и през самия gateway и да продължи свободно навън.
Навсякъде е използвана ключовата дума <tt>quick</tt>, за да не се налага PF
да обработва целия именуван набор с правила, когато нова връзка преминава
през gateway.

<p>
[<a href="ftp.html">Преди: Проблеми с FTP</a>]
[<a href="index.html">Съдържание</a>]
[<a href="example1.html">Следва: Пример #1: Firewall за дома или за малък 
офис</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[back]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
Оригинал: [ OpenBSD: authpf.html,v 1.1 2003/06/29 20:20:11 nick Exp ]<br>
$Id: authpf.html,v 1.1 2003/10/09 07:17:50 moo Exp $<br>
$Translation$<br>
$OpenBSD$
</small>
